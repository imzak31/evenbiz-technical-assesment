<%= form_with model: release, class: "space-y-6", data: { controller: "form album-toggle", action: "submit->form#submit" } do |form| %>
  <%= render "shared/form_errors", resource: release %>

  <!-- Release Details -->
  <div class="space-y-4">
    <h4 class="text-sm font-medium text-gray-900 border-b border-gray-200 pb-2">Release Details</h4>
    
    <div>
      <%= form.label :name, class: "block text-sm font-medium text-gray-700" %>
      <%= form.text_field :name, 
          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
          placeholder: "Enter release name" %>
    </div>

    <div>
      <%= form.label :released_at, "Release Date", class: "block text-sm font-medium text-gray-700" %>
      <%= form.date_field :released_at, 
          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
    </div>
  </div>

  <!-- Artists Selection (moved up so we can use selected artists for album) -->
  <div class="space-y-4">
    <h4 class="text-sm font-medium text-gray-900 border-b border-gray-200 pb-2">Artists</h4>
    
    <div>
      <p class="text-sm text-gray-500 mb-3">Select the artists for this release:</p>
      <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-48 overflow-y-auto border border-gray-200 rounded-md p-3">
        <% Artist.order(:name).each do |artist| %>
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" 
                   name="release[artist_ids][]" 
                   value="<%= artist.id %>"
                   id="artist_<%= artist.id %>"
                   class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                   data-album-toggle-target="artistCheckbox"
                   data-artist-name="<%= artist.name %>"
                   data-action="change->album-toggle#artistChanged"
                   <%= 'checked' if release.artist_ids.include?(artist.id) %>>
            <span class="text-gray-700 truncate"><%= artist.name %></span>
          </label>
        <% end %>
      </div>
      <%= hidden_field_tag "release[artist_ids][]", "" %>
    </div>
  </div>

  <!-- Album Section -->
  <div class="space-y-4">
    <h4 class="text-sm font-medium text-gray-900 border-b border-gray-200 pb-2">Album</h4>
    
    <%= form.fields_for :album, release.album || release.build_album do |album_form| %>
      <% if release.album&.persisted? %>
        <%= album_form.hidden_field :id %>
      <% end %>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Album Owner <span class="text-red-500">*</span></label>
          <% if release.album&.persisted? %>
            <!-- When editing, show dropdown with current artists -->
            <select name="release[album_attributes][artist_id]"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              <% release.artists.order(:name).each do |artist| %>
                <option value="<%= artist.id %>" <%= 'selected' if artist.id == release.album.artist_id %>><%= artist.name %></option>
              <% end %>
            </select>
          <% else %>
            <!-- When creating, dynamically populate from selected artists -->
            <select name="release[album_attributes][artist_id]"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                    data-album-toggle-target="albumArtistSelect">
              <option value="">Select artists first...</option>
            </select>
          <% end %>
          <p class="mt-1 text-xs text-gray-500">Select which artist owns this album</p>
        </div>

        <%= render "releases/album_fields", album_form: album_form, release: release %>
      </div>
    <% end %>
  </div>

  <!-- Actions -->
  <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
    <%= link_to "Cancel", releases_path, class: "rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50" %>
    <%= form.submit release.persisted? ? "Update Release" : "Create Release",
        class: "rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed",
        data: { form_target: "submit" } %>
  </div>
<% end %>
